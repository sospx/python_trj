{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header gradient-bg text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-hands me-2"></i>Программы фондов</h4>
                <a href="/donor/needy-requests" class="btn btn-light">
                    <i class="fas fa-hands-helping me-2"></i>Помочь напрямую
                </a>
            </div>
            <div class="card-body">

                {% if programs %}
                <div class="row">
                    {% for program in programs %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">{{ program.title }}</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">{{ program.description }}</p>
                                <div class="mb-2">
                                    <strong><i class="fas fa-tag me-2"></i>Категория:</strong>
                                    {% if program.category == 'food' %}Питание
                                    {% elif program.category == 'clothes' %}Одежда
                                    {% elif program.category == 'education' %}Образование
                                    {% elif program.category == 'entertainment' %}Развлечения
                                    {% elif program.category == 'books' %}Книги
                                    {% elif program.category == 'household' %}Товары для дома
                                    {% elif program.category == 'electronics' %}Техника
                                    {% elif program.category == 'children' %}Детские вещи
                                    {% else %}Другое{% endif %}
                                </div>
                                <div class="mb-2">
                                    <strong><i class="fas fa-building me-2"></i>Фонд:</strong> {{ program.full_name }}
                                </div>
                                {% if program.contact_info %}
                                <div class="mt-2">
                                    <strong><i class="fas fa-phone me-2"></i>Контакты:</strong> {{ program.contact_info }}
                                </div>
                                {% endif %}
                                <small class="text-muted d-block mt-2">
                                    <i class="fas fa-clock me-1"></i>Создано: {{ program.created_at[:16] }}
                                </small>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-warning btn-sm support-btn"
                                        data-program-id="{{ program.id }}"
                                        data-program-title="{{ program.title }}"
                                        data-program-author="{{ program.full_name }}"
                                        data-program-author-id="{{ program.user_id }}"
                                        data-program-contact="{{ program.contact_info }}">
                                    <i class="fas fa-hand-holding-heart me-1"></i>Поддержать программу
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <div class="feature-icon text-muted mb-3">
                        <i class="fas fa-hands"></i>
                    </div>
                    <h5>Пока нет активных программ</h5>
                    <p class="text-muted">Фонды скоро добавят новые программы помощи</p>
                    <a href="/donor/needy-requests" class="btn btn-primary mt-3">
                        <i class="fas fa-hands-helping me-2"></i>Помочь напрямую нуждающимся
                    </a>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для поддержки программы -->
<div class="modal fade" id="supportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Поддержка программы фонда</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="supportForm">
                <div class="modal-body">
                    <p><strong>Программа:</strong> <span id="modalProgramTitle"></span></p>
                    <p><strong>Фонд:</strong> <span id="modalProgramAuthor"></span></p>
                    <p><strong>Контакты фонда:</strong> <span id="modalProgramContact"></span></p>
                    
                    <div class="mb-3">
                        <label class="form-label">Ваше сообщение фонду</label>
                        <textarea class="form-control" name="message" rows="3"
                                  placeholder="Напишите сообщение для фонда (необязательно)..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Количество жертвуемых вещей</label>
                        <input type="number" class="form-control" name="quantity" 
                               placeholder="Например: 5 пар обуви, 10 книг" min="1">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ваши контактные данные *</label>
                        <input type="text" class="form-control" name="donor_contact" required
                               placeholder="Телефон, email для связи"
                               value="{{ session.get('contact_info', '') }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ваше имя *</label>
                        <input type="text" class="form-control" name="donor_name" required
                               placeholder="Как к вам обращаться"
                               value="{{ session.get('full_name', '') }}">
                    </div>
                    
                    <div class="alert alert-info">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            После отправки формы фонд получит ваши контактные данные для связи
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-warning">Откликнуться на программу</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('supportModal'));
    let currentProgramId = null;
    let currentAuthorId = null;

    // Обработчик для всех кнопок поддержки
    document.querySelectorAll('.support-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentProgramId = this.getAttribute('data-program-id');
            currentAuthorId = this.getAttribute('data-program-author-id');
            const title = this.getAttribute('data-program-title');
            const author = this.getAttribute('data-program-author');
            const contact = this.getAttribute('data-program-contact');

            document.getElementById('modalProgramTitle').textContent = title;
            document.getElementById('modalProgramAuthor').textContent = author;
            document.getElementById('modalProgramContact').textContent = contact || 'Не указаны';

            modal.show();
        });
    });

    // Обработчик отправки формы
    document.getElementById('supportForm').addEventListener('submit', function(event) {
        event.preventDefault();

            if (!currentProgramId || !currentAuthorId) {
                alert('Ошибка: Недостаточно данных для отправки отклика');
                return;
            }

        const formData = new FormData(this);
        
        // Добавляем дополнительные данные
        formData.append('program_id', currentProgramId);
        formData.append('author_id', currentAuthorId);

        fetch(`/donor/respond-to-fund-program/${currentProgramId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Ваш отклик успешно отправлен! Фонд получит ваши контактные данные и свяжется с вами.');
                modal.hide();
                this.reset();
                currentProgramId = null;
                currentAuthorId = null;
                
                // Обновляем страницу через 2 секунды
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                alert('❌ Ошибка: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Произошла ошибка при отправке отклика. Пожалуйста, попробуйте еще раз.');
        });
    });

    // Обработчик закрытия модального окна
    document.getElementById('supportModal').addEventListener('hidden.bs.modal', function () {
        document.getElementById('supportForm').reset();
        currentProgramId = null;
        currentAuthorId = null;
    });
});
</script>

<style>
.modal {
    z-index: 1060;
}

.modal-backdrop {
    z-index: 1050;
}

body.modal-open {
    overflow: auto !important;
    padding-right: 0 !important;
}

.modal {
    overflow-y: auto;
}

.modal-dialog {
    margin: 20px auto;
}

.progress {
    background-color: #e9ecef;
    border-radius: 5px;
}

.progress-bar {
    border-radius: 5px;
    transition: width 0.6s ease;
}
</style>
{% endblock %}

