{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header gradient-bg text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-inbox me-2"></i>–û—Ç–∫–ª–∏–∫–∏ –Ω–∞ –º–æ–∏ –∑–∞–ø—Ä–æ—Å—ã</h4>
                <div>
                    <a href="/needy/create-request" class="btn btn-light me-2">
                        <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å
                    </a>
                    <a href="/needy/available-help" class="btn btn-outline-light">
                        <i class="fas fa-search me-2"></i>–ù–∞–π—Ç–∏ –ø–æ–º–æ—â—å
                    </a>
                </div>
            </div>
            <div class="card-body">

                {% if responses %}
                <div class="row">
                    {% for response in responses %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 {% if response.responder_type == 'donor' %}border-success{% else %}border-warning{% endif %} shadow-sm">
                            <div class="card-header {% if response.responder_type == 'donor' %}bg-success text-white{% else %}bg-warning text-dark{% endif %} d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    {% if response.responder_type == 'donor' %}
                                        <i class="fas fa-hand-holding-heart me-1"></i>
                                    {% else %}
                                        <i class="fas fa-hands me-1"></i>
                                    {% endif %}
                                    –û—Ç {{ response.responder_name }}
                                </h6>
                                <div>
                                    <span class="badge {% if response.responder_type == 'donor' %}bg-light text-success{% else %}bg-dark text-warning{% endif %} me-2">
                                        {% if response.responder_type == 'donor' %}
                                            –ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å
                                        {% else %}
                                            –§–æ–Ω–¥
                                        {% endif %}
                                    </span>
                                    {% if response.status == 'new' %}
                                        <span class="badge bg-info">–ù–æ–≤—ã–π</span>
                                    {% elif response.status == 'contacted' %}
                                        <span class="badge bg-success">–°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong>
                                    <div class="border p-3 bg-light rounded mt-2">
                                        {{ response.message }}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <strong><i class="fas fa-user me-2"></i>–û—Ç:</strong>
                                            <span class="text-dark">{{ response.responder_name }}</span>
                                        </div>

                                        <div class="mb-2">
                                            <strong><i class="fas fa-tag me-2"></i>–¢–∏–ø –ø–æ–º–æ—â–∏:</strong>
                                            <span class="badge bg-primary">
                                                {% if response.help_type == 'food' %}–ü—Ä–æ–¥—É–∫—Ç—ã
                                                {% elif response.help_type == 'clothes' %}–û–¥–µ–∂–¥–∞
                                                {% elif response.help_type == 'education' %}–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
                                                {% elif response.help_type == 'entertainment' %}–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è
                                                {% elif response.help_type == 'books' %}–ö–Ω–∏–≥–∏
                                                {% elif response.help_type == 'household' %}–¢–æ–≤–∞—Ä—ã –¥–ª—è –¥–æ–º–∞
                                                {% elif response.help_type == 'electronics' %}–¢–µ—Ö–Ω–∏–∫–∞
                                                {% elif response.help_type == 'children' %}–î–µ—Ç—Å–∫–∏–µ –≤–µ—â–∏
                                                {% else %}–î—Ä—É–≥–æ–µ{% endif %}
                                            </span>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <strong><i class="fas fa-hands-helping me-2"></i>–ù–∞ –∑–∞–ø—Ä–æ—Å:</strong>
                                            <span class="text-muted">{{ response.request_title }}</span>
                                        </div>
                                    </div>
                                </div>

                                <hr>

                                <div class="alert alert-success">
                                    <strong><i class="fas fa-phone me-2"></i>–ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏:</strong>
                                    <div class="mt-1">
                                        <span class="fw-bold text-primary fs-5">{{ response.responder_contact }}</span>
                                    </div>
                                    <small class="text-muted">–°–≤—è–∂–∏—Ç–µ—Å—å —Å {% if response.responder_type == 'donor' %}–±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª–µ–º{% else %}—Ñ–æ–Ω–¥–æ–º{% endif %} –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–º–æ—â–∏</small>
                                </div>

                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>–ü–æ–ª—É—á–µ–Ω–æ: {{ response.created_at[:16] }}
                                </small>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100">
                                    <button class="btn btn-success contact-btn flex-fill"
                                            data-contact="{{ response.responder_contact }}"
                                            data-name="{{ response.responder_name }}"
                                            data-type="{{ response.responder_type }}">
                                        <i class="fas fa-phone me-1"></i>–°–≤—è–∑–∞—Ç—å—Å—è
                                    </button>
                                    {% if response.status == 'new' %}
                                    <button class="btn btn-outline-primary mark-contacted-btn flex-fill"
                                            data-response-id="{{ response.id }}">
                                        <i class="fas fa-check me-1"></i>–°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-outline-danger delete-response-btn flex-fill"
                                            data-response-id="{{ response.id }}">
                                        <i class="fas fa-trash me-1"></i>–£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="feature-icon text-muted mb-3">
                        <i class="fas fa-inbox fa-3x"></i>
                    </div>
                    <h4 class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫–ª–∏–∫–æ–≤</h4>
                    <p class="text-muted mb-4">–ö–∞–∫ —Ç–æ–ª—å–∫–æ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª–∏ –∏–ª–∏ —Ñ–æ–Ω–¥—ã –Ω–∞—á–Ω—É—Ç –æ—Ç–∫–ª–∏–∫–∞—Ç—å—Å—è –Ω–∞ –≤–∞—à–∏ –∑–∞–ø—Ä–æ—Å—ã, –æ—Ç–∫–ª–∏–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                    <div class="d-grid gap-2 d-md-block">
                        <a href="/needy/create-request" class="btn btn-primary btn-lg me-2">
                            <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–º–æ—â–∏
                        </a>
                        <a href="/needy/available-help" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-search me-2"></i>–ù–∞–π—Ç–∏ –ø–æ–º–æ—â—å
                        </a>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ö–Ω–æ–ø–∫–∞ "–°–≤—è–∑–∞—Ç—å—Å—è" - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã
    document.querySelectorAll('.contact-btn').forEach(button => {
        button.addEventListener('click', function() {
            const contact = this.getAttribute('data-contact');
            const name = this.getAttribute('data-name');
            const type = this.getAttribute('data-type');
            const typeText = type === 'donor' ? '–±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—è' : '—Ñ–æ–Ω–¥–∞';

            alert(`üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã ${typeText} "${name}":\n\n${contact}\n\n–°–≤—è–∂–∏—Ç–µ—Å—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–º–æ—â–∏.`);
        });
    });

    // –ö–Ω–æ–ø–∫–∞ "–°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    document.querySelectorAll('.mark-contacted-btn').forEach(button => {
        button.addEventListener('click', function() {
            const responseId = this.getAttribute('data-response-id');

            if (confirm('–û—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ —Å–≤—è–∑—å —Å –æ—Ç–∫–ª–∏–∫–Ω—É–≤—à–∏–º—Å—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞?')) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
                this.disabled = true;

                fetch(`/needy/mark-response-contacted/${responseId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω! –°–≤—è–∑—å –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è.');
                        location.reload();
                    } else {
                        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
                    this.innerHTML = originalText;
                    this.disabled = false;
                });
            }
        });
    });

    // –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å"
    document.querySelectorAll('.delete-response-btn').forEach(button => {
        button.addEventListener('click', function() {
            const responseId = this.getAttribute('data-response-id');

            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∫–ª–∏–∫? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>–£–¥–∞–ª–µ–Ω–∏–µ...';
                this.disabled = true;

                fetch(`/needy/delete-response/${responseId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('‚úÖ –û—Ç–∫–ª–∏–∫ —É–¥–∞–ª–µ–Ω!');
                        location.reload();
                    } else {
                        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç–∫–ª–∏–∫–∞');
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç–∫–ª–∏–∫–∞');
                    this.innerHTML = originalText;
                    this.disabled = false;
                });
            }
        });
    });
});
</script>

<style>
.contact-btn:hover {
    transform: translateY(-2px);
    transition: all 0.3s ease;
}

.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.badge {
    font-size: 0.75em;
}

.alert-success {
    border-left: 4px solid #28a745;
}
</style>
{% endblock %}

